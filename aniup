#!/usr/bin/env bash
# Quick and dirty script to increment the watched count for an episode.
#
# Dependencies: wget, jq, fzf
#
# Optional environment variables:
#   $KITSU_USERNAME: The default username to check. Can be overriden with $1.
#     Overriding this unsets $KITSU_PASSWORD.
#   $KITSU_PASSWORD: The password corresponding to $KITSU_USERNAME. If unset,
#     `read -s` is used to get the password.

checkdep() {
  which "$1" &>/dev/null || echo " $1"
}

missing="$(checkdep wget)$(checkdep jq)$(checkdep fzf)"
if [ "$missing" ]; then
  echo "The following dependencies are missing:$missing"
  exit 1
fi

usage() {
  echo "Usage: $(basename "$0") [kitsu.io username]"
  exit 1
}

# Complain if too many args
[ "$#" -gt 1 ] && usage
[[ "$1" == -* ]] && usage

# If arg provided, use it
[ "$1" ] && KITSU_USERNAME="$1" && KITSU_PASSWORD=''

# Check for required variables
if [ -z "$KITSU_USERNAME" ]; then
  echo 'Required: $KITSU_USERNAME'
  exit 1
fi

api="https://kitsu.io/api/edge"

# Get user ID
echo "Fetching kitsu.io profile for $KITSU_USERNAME..."
uid="$(wget -qO- \
  "$api/users\
?fields[users]=id\
&filter[name]=$KITSU_USERNAME" |\
  jq -r '.data[0].id')"

# Fetch entries
echo "Fetching library entries for user ID $uid..."
entries=$(wget -qO- \
  "$api/library-entries\
?page[limit]=500\
&include=anime\
&fields[libraryEntries]=progress,anime\
&fields[anime]=canonicalTitle,episodeCount\
&filter[status]=current\
&filter[userId]=$uid" |\
  jq -r '(
    .included |
    map({key: .id,
         value: {title: .attributes.canonicalTitle,
                 eps: .attributes.episodeCount}}) | from_entries
  ) as $index | .data[] | $index[.relationships.anime.data.id] as $entry |
  "\(.id)\t\(.attributes.progress)/\($entry.eps)\t\($entry.title)"')

if [ -z "$entries" ]; then
  echo "No entries found for $KITSU_USERNAME."
  exit 0
fi

# Get user selection
selection="$(fzf --with-nth 2.. <<< "$entries")"
[ -z "$selection" ] && exit 0
id="$(cut -f1 <<< "$selection")"
ep_stats="$(cut -f2 <<< "$selection")"
anime="$(cut -f3- <<< "$selection")"
next_ep="$((${ep_stats%%/*} + 1))"

[ -z "$KITSU_PASSWORD" ] && read -sp \
  "Enter the password for $KITSU_USERNAME: " KITSU_PASSWORD
echo

echo
echo "ID: $id"
echo "Name: $anime"
echo "Stats: $ep_stats"
echo "Next: $next_ep"
echo "Password: $KITSU_PASSWORD"

exit 5

# TODO: update below
# Update the entry
update_url="$api/libraries/$id"
update_data="auth_token=$ANIUP_TOKEN&id=$id&increment_episodes=true"
ep="$(wget -qO- "$update_url" -X POST -d "$update_data" |
      jq -r '.episodes_watched')"
if [ -z "$ep" ]; then
  echo "Unable to update watched count for \"$anime\"."
  exit 1
fi

echo "Updated \"$anime\" to episode $ep."
