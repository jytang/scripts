#!/usr/bin/env bash
# Fetch info about your system
#
# Created by Dylan Araps
# https://github.com/dylanaraps/dotfiles/
# Modified by Ethan Chan
# https://github.com/metakirby5/dotfiles/

# Import some variables
fetch_vars=~/.fetch_vars
[ -f "$fetch_vars" ] && source "$fetch_vars"

# Text
title="$(whoami)"
underline="$(printf %"${#title}"s |tr " " "=")="
declare -A info=(
  ["OS"]="Fedora"
  ["Shell"]="Bash"
  ["Window Manager"]="i3"
  ["Font"]="PixelMPlus12"
  ["Waifu"]="Black Rock Shooter"
)

# Colors
primary_n="${PRIMARY_N:=1}"
secondary_n="${SECONDARY_N:=4}"
primary="$(tput setaf $primary_n)"
secondary="$(tput setaf $secondary_n)"
black="$(tput setaf 0)"
bold="$(tput bold)"
clear="$(tput sgr0)"

put_color_header() {
    local text
    for i in `seq 0 7`; do
        case "$i" in
            "$primary_n")     text=' .. ' ;;
            "$secondary_n")   text=' __ ' ;;
            *)                text='    ' ;;
        esac

        echo -n "$(tput setaf $i)$bold$text$clear "
    done
}
put_colors() {
    for i in `seq $1 $2`; do
        echo -n "$(tput setab $i)    $clear "
    done
}

# Image
walltempdir=~/.fetch
width=312
height=312
yoffset=0
xoffset=0
pad="                       "

# If no image provided
if [ -z "$img" ]; then
    # Image shall be the wallpaper
    wallpaper="$(cat ~/.fehbg | cut -d\' -f2)"
    img="$walltempdir/$(basename $wallpaper)"

    # Crop if necessary
    if [ ! -f "$img" ]; then
        [ ! -d "$walltempdir" ] && (mkdir "$walltempdir" || exit)
        size="$(identify -format '%h' $wallpaper)"
        convert -crop "$size"x"$size"+0+0 -gravity center "$wallpaper" -resize "$height"x"$height" "$img"
    fi
fi

# Print info
clear
tput civis
echo "$pad$bold${primary}$title${clear}"
echo "$pad$bold${black}$underline"
for i in "${!info[@]}"; do
    echo "$pad$bold${secondary}$i${clear}: ${info[$i]}"
done
echo "$pad$(put_color_header)"
echo "$pad$(put_colors 0 7)"
echo "$pad$(put_colors 8 15)"
echo -e "0;1;$xoffset;$yoffset;$width;$height;;;;;$img\n4;\n3;" | /usr/lib/w3m/w3mimgdisplay
tput cnorm

